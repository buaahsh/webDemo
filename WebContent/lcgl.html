<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>运行支持平台-管理维护</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <script src="js/jQuery.js"></script>
    <script src="js/jQuery.cookie.js"></script>
    <script src="js/bootstrap.min.js"></script>
    
    <script src="js/UserLogin.js"></script>
    
    
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
    <style type="text/css">
    .container{
    	background-color:#ffffff;
    }
    .banner{
    	border-top:solid 5px #0e618a;
    }
    .footer,.footer a{
	    color:white;
    }
    .footer p{
	    float:left;
	    margin-left:420px;
	    margin-top:45px;
    }
    td.title{
    	font-weight:bold;
    }
    div#btn{
    	text-align:center;
    }
    div#btn button{
    	margin:0px 25px
	}
    </style>
  </head>
  <body>
	<div class="container">
	<div class="banner"><img src="img/top_01.jpg"></div>
	<div class="navbar"  role="navigation" id="navbar">
	<ul class="nav">
		<li><a href="index.html">首页</a></li>
		<li><a href="hjyx.html">环境运行</a></li>
		<li  class="active"><a href="yhgl.html">管理维护</a></li>
		<li><a href="jszc.html">技术支持</a></li>
		<li><a href="wzgl.html">网站管理</a></li>
	</ul>
	</div>
	<div class="row" style="clear:both; padding-top:10px;">
		<div class="span3 bs-docs-sidebar" style="float:left;">
		<div class="nav nav-list">
			<div class="list-group" id="list-group"  style="background:#f5f5f5; border-radius:5px; box-shadow:0 0 10px #ccc;
 padding:10px; " >
				<a class="list-group-item" href="yhgl.html" id="cateuser">用户管理</a> <br><br>
				<a class="list-group-item" href="?category=job" id="catejob">作业管理</a>  <br><br>
				<a class="list-group-item" href="?category=cluster" id="catecluster">集群管理</a> <br><br>
				<a class="list-group-item" href="?category=soft" id="catesoft">软件管理</a> <br><br>
				<a class="list-group-item" href="?category=notice" id="notice">通知通告</a>
			</div>
		</div>
		</div>
		<div class="span9" id="content" style="float:right;">
			
			<h3 align="center">用户流程管理</h3>
			<table class="table table-bordered table-hover table-condensed" id="userInfo">
				<tr class="success"><td class="title" colspan="3" id="name" class="name">用户名</td><td class="title" colspan="3" id="status">状态</td></tr>
				<tr><td colspan="6"><div align="center" id="picture"></div></td></tr>
				<tr class="success"><td colspan="6" class="title">申请表跟踪</td></tr>
				<tr><td colspan="6">
				<div class="accordion" id="accordion2">
				    <div class="accordion-heading">
				      <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
				        全部申请表跟踪
				      </a>
				    </div>
				    <div id="collapseOne" class="accordion-body collapse">
				      <div class="accordion-inner" id="applyProcess">
				      </div>
				    </div>
				</div>
				<tr class="success"><td colspan="6" class="title">申请表信息</td></tr>
				<tr><td colspan="3" id="name">用户名:User4</td><td colspan="3" id="adress">通信地址：XXXXXXXXX</td></tr>
				<tr><td colspan="3" id="email">邮箱:User4@sccas.cn</td><td colspan="3" id="tel">联系电话：xxx-xxxxxxx</td></tr>
				<tr><td colspan="3" id="applicant">申请人:贾六</td><td colspan="3" id="applyDoc">申请材料:</td></tr>
				<tr><td colspan="3" id="applyCompany">申请单位:XXXXXX</td><td colspan="3" id="projectInfo">项目信息:</td></tr>
				<tr><td colspan="6"></td></tr>
				<tr><td colspan="3" id="memory">申请内存:8G</td><td colspan="3" id="soft">软件需求:gaussian、vasp</td></tr>
				<tr><td colspan="3" id="hard">申请硬盘:50G</td><td colspan="3" id="VPN">VPN:User4</td></tr>
				<tr><td colspan="3" id="machineHours">机时总量:1万CPU小时</td><td colspan="3" id="other">其它:</td></tr>
				<tr><td colspan="6" id="remarks">备注:<button class="btn btn-mini pull-right" id="addRemarks">添加</button></td></tr>
			</table>
			<div id="btn"><!--<button class="btn" >退修</button><button class="btn" >通过</button>!--></div>
				
		</div>
	
	</div>
	<hr />
	<div class="footer" style="background-image: url(img/foot.jpg); height: 95px;">
  		<p>版权所有 © <a href="http://www.jsi.buaa.edu.cn/">Sino-German Joint software Institude</a>, <a href="http://www.buaa.edu.cn">Beihang Univ.</a></p>
    </div>
    </div>
    <script type="text/javascript">
    	//申请表格不同状态进行绘制
    	var user = window.location.href.split("=")[1];
    	var status = "";
    	$.getJSON("/webDemo/Account?user="+user, null, function(data){
       		$("td#name").empty().append("用户名:"+data.name);
       		$("td#status").empty().append("状态:"+data.status);
       		$("td#adress").empty().append("通信地址:"+data.adress);
       		$("td#email").empty().append("邮箱:"+data.email);
       		$("td#tel").empty().append("电话:"+data.tel);
       		$("td#applicant").empty().append("申请人:"+data.applicant);
       		$("td#applyDoc").empty().append("申请材料:"+data.applyDoc);
       		$("td#applyCompany").empty().append("申请单位:"+data.applyCompany);
       		$("td#projectInfo").empty().append("项目信息:"+data.projectInfo);
       		$("td#memory").empty().append("申请内存:"+data.memory);
       		$("td#soft").empty().append("软件需求:"+data.soft);
       		$("td#hard").empty().append("申请硬盘:"+data.hard);
       		$("td#VPN").empty().append("VPN:"+data.VPN);
       		$("td#machineHours").empty().append("机时总量:"+data.machineHours);
       		$("td#other").empty().append("其他:"+data.other);
       		
       		$("td#remarks").empty().append("备注:"+data.remarks+"<button class='btn btn-mini pull-right' id='addRemarks'>添加</button>");
       		
       		//填写申请表流程
       		$("div#applyProcess").empty();
       		$.each(data.applyProcess, function(idx, item){
       			$("div#applyProcess").append("<div class='line'>"+item+"</div>");
		   	});
       		//根据不同状态创建button

        	status = data.status;
        	//对于有uid的状态，加入uid一项
        	if(status=="待映射"||status=="创建VPN"||status=="映射失败"||status=="待设试用"||status=="待转正"||status=="正式")
        	{
        		$("table#userInfo").append("<tr><td colspan='6' id='uid'>UID:"+data.uid+"</td></tr>");
        	}
			//对于有集群映射的，建立集群映射项
        	if(status=="创建VPN"||status=="映射失败"||status=="待设试用"||status=="待转正"||status=="正式")
        	{
        		$("table#userInfo").append("<tr><td colspan='6' id='clusterMap'>集群映射"+"<button class='btn btn-mini pull-right' id='getMapBtn'>查看</button></td></tr>");
        	}
			
        	if(status=="待确认")
        	{
        		$("div#picture").empty().append("<img src='img/liucheng/liucheng_1.jpg'/>");
        	}
       		if(status=="待审批"||status=="退修"||status=="修回")
	       {
	       		$("div#picture").empty().append("<img src='img/liucheng/liucheng_2.jpg'/>");
	       		$("div#btn").empty().append(
	       			"<button class='btn' >退修</button>"
	       			+"<button class='btn' >通过</button>"
	       			+"<button class='btn' >置为无效</button>"
	       			+"<button class='btn' >编辑</button>"
	       		);
	       }
	       else if(status=="待建立")
	       {
	       		$("div#picture").empty().append("<img src='img/liucheng/liucheng_3.jpg'/>");
       			$("div#btn").empty().append(
       				"<button class='btn' >创建账户</button>"
       				+"<button class='btn' >编辑</button>");
	       }
	       else if(status=="待映射")
	       {
	       		$("div#picture").empty().append("<img src='img/liucheng/liucheng_4.jpg'/>");
	       		$("div#btn").empty().append("<button class='btn' >创建映射</button><button class='btn' >编辑</button>");
	       }
	       else if(status=="映射失败")
	       {
	       		$("div#picture").empty().append("<img src='img/liucheng/liucheng_5.jpg'/>");
	       }
	       else if(status=="创建VPN")
	       {
	       		$("div#picture").empty().append("<img src='img/liucheng/liucheng_5.jpg'/>");
	       		$("div#btn").empty().append("<button class='btn' >开通VPN</button><button class='btn' >编辑</button>");
	       }
	       else if(status=="待设试用")
	       {
	       		$("div#picture").empty().append("<img src='img/liucheng/liucheng_6.jpg'/>");
	       		$("div#btn").empty().append("<button class='btn' >设置为试用账户，通知用户</button><button class='btn' >编辑</button>");
	       }
	       else if(status=="待转正")
	       {
	       		$("div#picture").empty().append("<img src='img/liucheng/liucheng_7.jpg'/>");
	       		$("div#btn").empty().append("<button class='btn' >重置密码</button><button class='btn' >转正</button><button class='btn' >锁定</button><button class='btn' >编辑</button>");
	       }
	       else if(status=="正式")
	       {
	       		$("div#picture").empty().append("<img src='img/liucheng/liucheng_8.jpg'/>");
	       		$("div#btn").empty().append("<button class='btn' >重置密码</button><button class='btn' >锁定</button><button class='btn' >编辑</button>");
	       }
       });
    </script>
    <script type="text/javascript">
    	// 不同的按钮进步不同的操作
    	$("body").on("click","div#btn button",function(){
    		var value = $(this).text();
    		if(value=="锁定")
    			return;
    		if(value=="编辑")
    		{
    			var content = "<div class='form-horizontal'>";
    			$.each($("[colspan='3']:not(.title):not(#email):not(#applyDoc):not(#projectInfo):not(#soft):not(#VPN):not(#other)")
    					,function(idx, item){
    				if(item.attributes["id"].nodeValue=="name"){
    					content +=
    					"<div class='control-group'><label class='control-label'>"
	    				 + item.textContent.split(":")[0]
	    				 +"</label><div class='controls'>"
	      				 +"<input class='uneditable-input' type='text' id="+item.attributes["id"].nodeValue
	      				 +" value="+item.textContent.split(":")[1]+"></div></div>";
    				}
    				else{
	    				content +=
	    				 "<div class='control-group'><label class='control-label'>"
	    				 + item.textContent.split(":")[0]
	    				 +"</label><div class='controls'>"
	      				 +"<input type='text' id="+item.attributes["id"].nodeValue
	      				 +" value="+item.textContent.split(":")[1]+"></div></div>";
	      			}
    			});
    			content += "<div class='control-group'><div class='controls'><button class='btn' id='editInfoBtn'>编辑</button><button class='btn' onclick='location.reload()'>取消</button></div></div></div>"
    			$("div#content").empty().append(
    				content
    			);
    			return;
    		}
    		var r=confirm("确定"+value+"?");
			if (r==true){
				if(value=="退修")
				{
					$.get("/webDemo/Email?user="+ $("td#name").text().split(":")[2] + "&emailArg=tuixiu", function(result){
						var emailContent = result;
						$("div#content").empty().append("<form>"
							+"<textarea rows='20' class='input-xxlarge'>"+emailContent+"</textarea>"
							+"</form>"
							+"<button class='btn' id='sendTuixiuBtn'>发送</button>"
							+"<button class='btn' onclick='location.reload()'>取消</button>"
							);
					});
				}
				else if(value=="置为无效")
					$.get("/webDemo/ApprovalStatusServlet?user="+$("td#name").text().split(":")[2]+"&arg=11",function(result){
						if (result=="#ERROR#")
	        				alert("权限不够，添加备注失败");
	        			else
	        				location.reload();
					});
				else if(value=="创建账户")
				{
					var name = $("td#name").text().split(":")[2];
					$("div#content").empty().append("<form><label>用户名:"+name+"</label><input type='text' placeholder='UID' id='uidInput'></form><button class='btn' id='createBtn'>创建</button>");
				}
				else if(value=="设置为试用账户，通知用户")
				{
					$.get("/webDemo/Email?user="+ $("td#name").text().split(":")[2] + "&emailArg=shiyong", function(result){
						var emailContent = result;
						$("div#content").empty().append("<form>"
							+"<textarea rows='20' class='input-xxlarge'>"+emailContent+"</textarea>"
							+"</form>"
							+"<button class='btn' id='sendShiyongBtn'>发送</button>"
							+"<button class='btn' onclick='location.reload()'>取消</button>"
							);
					});
				}
				else if(value=="转正")
				{
					$.get("/webDemo/Email?user="+ $("td#name").text().split(":")[2] + "&emailArg=zhengshi", function(result){
						var emailContent = result;
						$("div#content").empty().append("<form>"
							+"<textarea rows='20' class='input-xxlarge'>"+emailContent+"</textarea>"
							+"</form>"
							+"<button class='btn' id='sendZhengshiBtn'>发送</button>"
							+"<button class='btn' onclick='location.reload()'>取消</button>"
							);
					});
				}
				else if(value=="重置密码")
				{
					var name = $("td#name").text().split(":")[2];
					$("div#content").empty().append("<form><label>用户名:"+name+"</label><input type='password' id='inputPassword' placeholder='Password'><input type='password' id='inputPassword_1' placeholder='Re-enter'></form><button class='btn' id='passwordBtn'>重置密码</button>");
				}
				else if(value=="创建映射")
				{
					var name = $("td#name").text().split(":")[2];
					var uid = $("td#uid").text().split(":")[1];
					var clusterContent = "";
					$.getJSON("/webDemo/AccountMap?cluster=test", null, function(data){
    					$.each(data,function(idx, item){
    						if (idx%5==0)
    						{
    							if (idx>0)
    								clusterContent += "</div>";
    							clusterContent += "<br/><div class='form-inline'>";
    						}
    						if (idx < 5)
    						{
    							clusterContent += "<label class='checkbox'><input type='checkbox' value="+item.name+" checked='checked'>"+item.name+"</label>";
    						}
    						else
    						{
    							clusterContent += "<label class='checkbox'><input type='checkbox' value="+item.name+">"+item.name+"</label>";
    						}
    						
    					});
    					clusterContent += "</div>";
    					$("div#content").empty().append(
    						"<form><fieldset><label>用户名:"+name+"</label>"
    						+"<label>uid:"+uid+"</label>"
    						+"<input id='mapAccount' placeholder='映射账号'>"
    						+clusterContent+"</fieldset></form>"
							+"<button class='btn' id='mapBtn'>创建映射</button>");
    					});
				}
				else if(value=="开通VPN")
					$.get("/webDemo/BuildVPNStatusServlet?user="+$("td#name").text().split(":")[2]+"&arg=0",function(result){
						if (result=="#ERROR#")
	        				alert("权限不够");
	        			else
	        				location.reload();
					});
				else if(value=="通过")
					$.get("/webDemo/ApprovalStatusServlet?user="+$("td#name").text().split(":")[2]+"&arg=0",function(result){
						if (result=="#ERROR#")
	        				alert("权限不够");
	        			else
	        				location.reload();
					});
			}
			else
			  alert("您已经取消了");
    	});
    
    </script>
    <script type="text/javascript">
    	// 创建用户的页面进行处理，post用户数据
    	var user = window.location.href.split("=")[1];
    	$("body").on("click","button#createBtn",function(){
			var json={"user":user,"uid":$("input#uidInput").val()};
            var post={data:JSON.stringify(json)};//JSON.stringify(json)把json转化成字符串
            $.get("/webDemo/BuildAccountStatusServlet?user="+user+"&arg=0",function(result){
 				if (result=="#ERROR#")
 				{
 					alert("权限不够");
 					location.reload();
 				}
    			else
    			{
    				$.post("/webDemo/AccountCreate",post,function(result){
    		            //	1	创建成功
    					//	2	创建失败，uid已经被占用
    				 	//	3	创建失败，uid不存在
    			 		if(result=="1"){
    			 			alert("创建成功");
    			 			location.reload();
    			 		}
    			 		else if(result=="2"){
    			 			alert("创建失败，uid已经被占用");
    			 		}
    			 		else if(result=="3"){
    			 			alert("创建失败，uid不存在");
    			 		}
    	            });
    			}
			});
            
		});
    </script>
    <script type="text/javascript">
    	//创建映射
    	var user = window.location.href.split("=")[1];
    	$("body").on("click","button#mapBtn",function(){
    		var mapArray = new Array();
    		var i = 0;
    		$.each($("[type='checkbox']"),function(idx, item){
    			
    			if(item.checked)
    				mapArray[i++] = {"cluster":item.value,"mapAccount":$("input#mapAccount").val()}
    		});
			var json={"name":user,"mapArray":mapArray};
            var post={data:JSON.stringify(json)};//JSON.stringify(json)把json转化成字符串
            $.get("/webDemo/BuildMapStatusServlet?user="+user+"&arg=7",function(result){
 				if (result=="#ERROR#")
 				{
 					alert("权限不够");
 					location.reload();
 				}
    			else
    			{
    				 $.post("/webDemo/AccountMap",post,function(result){
    			            //	1	创建成功
    				 		if(result=="1"){
    				 			alert("映射创建成功");
    				 			location.reload();
    				 		}
    				 		else{
    				 			alert("创建失败");
    				 		}
    		            });
    			}	
			});
           
		});
    </script>
    <script type="text/javascript">
    	//查看映射 编辑映射
    	var user = window.location.href.split("=")[1];
    	$("body").on("click","button#getMapBtn",function(){
    		$("div#content").empty().append("<table class='table table-bordered table-hover table-condensed'><tr class='success'><td colspan='2'>用户名</td><td colspan='2'>集群</td><td colspan='2'>映射账号</td><td colspan='2'>状态</td></tr></table>");
    		$.getJSON("/webDemo/AccountMap?user="+user, null, function(data){
    			var hasAddedCluser = new Array();
    			var mapAccount;
    			Array.prototype.contains = function(obj) {    
					var i = this.length;    
					while (i--) {    
					if (this[i] === obj)
						return true;
					}    
					return false;    
				}   
    			$.each(data,function(idx, item){
    				hasAddedCluser.push(item.cluster);
    				mapAccount = item.mapAccount;
    				$("table").append("<tr><td colspan='2'>"+user+"</td><td colspan='2'>"+item.cluster+"</td><td colspan='2'>"+item.mapAccount+"</td><td colspan='2'>"+item.status+"</td></tr>");
    			});
    			$.getJSON("/webDemo/AccountMap?cluster=test", null, function(clusterData){
    				$("div#content").append("<div><input id='mapAccount' placeholder='映射账号' value="+mapAccount+"><form></form></div>")
    				$.each(clusterData,function(idx, item){
    						if (hasAddedCluser.contains(item.name)==false)
    							$("form").append("<label class='checkbox'><input type='checkbox' value="+item.name+">"+item.name+"</label>");
    					});
    				$("div#content").append("<button class='btn' id='mapBtn'>添加</button><button class='btn' onclick='location.reload()'>取消</button>")
    			});
       		});
    	});
    </script>
    <script type="text/javascript">
    	// 重置密码
    	var user = window.location.href.split("=")[1];
    	$("body").on("click","button#passwordBtn",function(){
    		if ($("input#inputPassword").val()!=$("input#inputPassword_1").val())
    		{
    			alert("两次密码不一致");
    			return;
    		}
			var json={"user":user,"password":$("input#inputPassword").val()};
            var post={data:JSON.stringify(json)};//JSON.stringify(json)把json转化成字符串
            $.post("/webDemo/Password",post,function(result){
	            //	1	重置密码成功
		 		if(result=="1"){
		 			alert("重置密码成功");
					location.reload();
		 		}
		 		else if (result=="#ERROR#"){
		 			alert("权限b");
					location.reload();
		 		}
		 		else{
		 			alert("重置密码失败，请重试");
		 		}
            });
		});
	
	</script>
    <script type="text/javascript">
    	$("body").on("click","button#editInfoBtn",function(){
    		var json={};
    		$.each($("input"),function(idx, item){
    			json[item.attributes["id"].nodeValue] = item.value;
    		});
    		
    		var post={data:JSON.stringify(json)};
    		$.post("/webDemo/EditAccountInfo",post,function(data){
    			if(data=="1"){
					alert("修改成功");
					location.reload();
				}
    		});
    	});
    </script>
    <script type="text/javascript">
	    //发送邮件
	    var user = window.location.href.split("=")[1];
    	$("body").on("click","button#sendTuixiuBtn",function(){
    		var json={"user":user,"email":$("textarea").val()};
            var post={data:JSON.stringify(json)};//JSON.stringify(json)把json转化成字符串
            $.get("/webDemo/ApprovalStatusServlet?user="+user+"&arg=3",function(result){
 				if (result=="#ERROR#")
 				{
 					alert("权限不够");
 					location.reload();
 				}
 				else{
 					 $.post("/webDemo/Email",post,function(result){
 			            //	1	发送成功
 				 		if(result=="1"){
 				 			alert("发送成功");
 				 		}
 				 		location.reload();
 		            });
 				}
			});
           
    	});
    	$("body").on("click","button#sendShiyongBtn",function(){
    		var json={"user":user,"email":$("textarea").val()};
            var post={data:JSON.stringify(json)};//JSON.stringify(json)把json转化成字符串
            $.get("/webDemo/BuildTrialStatusServlet?user="+user+"&arg=0",function(result){
 				if (result=="#ERROR#")
 				{
 					alert("权限不够");
 					location.reload();
 				}
 				else{
					 $.post("/webDemo/Email",post,function(result){
			            //	1	发送成功
				 		if(result=="1"){
				 			alert("发送成功");
				 		}
				 		location.reload();
		            });
				}
			});
    	});
    	$("body").on("click","button#sendZhengshiBtn",function(){
    		var json={"user":user,"email":$("textarea").val()};
            var post={data:JSON.stringify(json)};//JSON.stringify(json)把json转化成字符串
            $.get("/webDemo/BuildOfficialStatusServlet?user="+user+"&arg=0",function(result){
 				if (result=="#ERROR#")
 				{
 					alert("权限不够");
 					location.reload();
 				}
 				else{
					 $.post("/webDemo/Email",post,function(result){
			            //	1	发送成功
				 		if(result=="1"){
				 			alert("发送成功");
				 		}
				 		location.reload();
		            });
				}
			});
    	});
	</script>
    <script type="text/javascript">
    	// 不同的按钮进行不同的操作
    	//添加备注
    	$("body").on("click","button#addRemarks",function(){
			var remark=prompt("添加备注","");
			if (remark!=null && remark!=""){
				var user = window.location.href.split("=")[1];
				var json={"user":user,"remark":remark};
        		var post={data:JSON.stringify(json)};//JSON.stringify(json)把json转化成字符串
        		$.post("/webDemo/Account",post,function(result){
        			if (result=="#ERROR#")
        				alert("权限不够，添加备注失败");
        			else
        				location.reload();
        		});
			}
			return;
    	});
    </script>
    <script src="js/UserLogin.js"></script>
  </body>
</html>